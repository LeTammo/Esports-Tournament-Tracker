<div class="card mb-4">
    <div class="card-body">
        <div class="d-flex align-items-center justify-content-between">
            <h5 class="card-title m-0">Filters</h5>
            <button class="icon-toggle" type="button" id="toggle-filters" aria-expanded="false"
                    aria-controls="filters-collapse" title="Toggle filters" aria-label="Toggle filters">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"
                     class="chevron">
                    <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                          stroke-linejoin="round"/>
                </svg>
            </button>
        </div>
        <div id="filters-section">
            <script>
                function updateTournamentVisibility() {
                    var collapse = document.getElementById('filters-collapse');
                    var list = document.querySelectorAll('.tournament-item.filtered');
                    if (!collapse || !list) return;
                    var unfolded = !collapse.classList.contains('d-none');
                    if (unfolded) {
                        list.forEach(function (li) {
                            li.classList.remove('d-none');
                        });
                    } else {
                        list.forEach(function (li) {
                            li.classList.add('d-none');
                        });
                    }
                }

                function addIncludeRule() {
                    const idx = document.querySelectorAll('#include-rules .input-group').length;
                    const div = document.createElement('div');
                    div.className = 'input-group mb-1';
                    div.innerHTML = `
            <select class="form-select" name="include_type_${idx}">
              <option value="has">Has in name</option>
              <option value="starts">Starts with</option>
              <option value="ends">Ends with</option>
            </select>
            <input type="text" class="form-control" name="include_value_${idx}" placeholder="Value">
            <button class="btn btn-outline-danger" type="button" onclick="this.parentNode.remove();">Remove</button>
            `;
                    document.getElementById('include-rules').appendChild(div);
                }

                function addExcludeRule() {
                    const idx = document.querySelectorAll('#exclude-rules .input-group').length;
                    const div = document.createElement('div');
                    div.className = 'input-group mb-1';
                    div.innerHTML = `
            <select class="form-select" name="exclude_type_${idx}">
              <option value="has">Has in name</option>
            </select>
            <input type="text" class="form-control" name="exclude_value_${idx}" placeholder="Value">
            <button class="btn btn-outline-danger" type="button" onclick="this.parentNode.remove();">Remove</button>
            `;
                    document.getElementById('exclude-rules').appendChild(div);
                }

                (function () {
                    document.addEventListener('DOMContentLoaded', function () {
                        var btn = document.getElementById('toggle-filters');
                        var collapse = document.getElementById('filters-collapse');
                        if (!btn || !collapse) return;
                        btn.addEventListener('click', function () {
                            var willShow = collapse.classList.contains('d-none');
                            if (willShow) {
                                collapse.classList.remove('d-none');
                                btn.setAttribute('aria-expanded', 'true');
                                btn.classList.add('open');
                            } else {
                                collapse.classList.add('d-none');
                                btn.setAttribute('aria-expanded', 'false');
                                btn.classList.remove('open');
                            }
                            updateTournamentVisibility();
                        });
                        updateTournamentVisibility();
                    });
                })();
            </script>
            <div class="d-none mb-2" id="filters-collapse">
                <form id="filters-form">
                    <input type="hidden" name="tier_id" value="<%= selectedTier %>">
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Include Rules</label>
                            <button class="btn btn-sm btn-outline-primary" type="button" onclick="addIncludeRule()">
                                Add Include Rule
                            </button>
                            <div id="include-rules">
                                <% (filters && filters.include ? filters.include : []).forEach((rule, idx) => { %>
                                    <div class="input-group mb-1">
                                        <select class="form-select" name="include_type_<%= idx %>">
                                            <option value="has" <%= rule.type === 'has' ? 'selected' : '' %>>
                                                Has in name
                                            </option>
                                            <option value="starts" <%= rule.type === 'starts' ? 'selected' : '' %>>
                                                Starts with
                                            </option>
                                            <option value="ends" <%= rule.type === 'ends' ? 'selected' : '' %>>
                                                Ends with
                                            </option>
                                        </select>
                                        <input type="text" class="form-control" name="include_value_<%= idx %>"
                                               value="<%= rule.value %>" placeholder="Value">
                                        <button class="btn btn-outline-danger" type="button" onclick="this.parentNode.remove();">
                                            Remove
                                        </button>
                                    </div>
                                <% }) %>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Exclude Rules</label>
                            <button class="btn btn-sm btn-outline-danger" type="button" onclick="addExcludeRule()">
                                Add Exclude Rule
                            </button>
                            <div id="exclude-rules">
                                <% (filters && filters.exclude ? filters.exclude : []).forEach((rule, idx) => { %>
                                    <div class="input-group mb-1">
                                        <select class="form-select" name="exclude_type_<%= idx %>">
                                            <option value="has" <%= rule.type === 'has' ? 'selected' : '' %>>Has in
                                                name
                                            </option>
                                        </select>
                                        <input type="text" class="form-control" name="exclude_value_<%= idx %>"
                                               value="<%= rule.value %>" placeholder="Value">
                                        <button class="btn btn-outline-danger" type="button"
                                                onclick="this.parentNode.remove();">Remove
                                        </button>
                                    </div>
                                <% }) %>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-success btn-sm" type="submit">Save Filters</button>
                </form>
            </div>
        </div>
    </div>
</div>

